<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â„ï¸2025é»„è±†è±†å†¬å¥¥ä¼šç¾½æ¯›çƒåˆ†ä¼šåœºğŸ†</title>
    <style>
        /* é…·ç‚« V7.2ï¼šå¥¥è¿äº”ç¯ä¸»é¢˜é…è‰² (æ·±è“/æµ…è“/ç™½ ä¸»é¢˜) */
        :root {
            /* ä¸»é¢˜è‰² */
            --color-bg: #E0F2F7;       /* ææµ…è“ç™½èƒŒæ™¯ */
            --color-surface: #FFFFFF;    /* çº¯ç™½æ¨¡å—è¡¨é¢ */
            --color-text: #2C3E50;       /* æ·±è“ç°æ–‡å­— */
            --color-deep-blue: #1A2942;  /* ä¸»é¢˜æ·±è“ï¼Œç”¨äºæ ‡é¢˜ã€é‡è¦è¾¹æ¡† */
            --color-light-blue: #87CEEB; /* ä¸»é¢˜æµ…è“ï¼Œç”¨äºæ¬¡è¦å¼ºè°ƒ */

            /* å¥¥è¿äº”ç¯æŒ‰é’®é¢œè‰² */
            --olympic-blue: #0081C8;     /* è“è‰² - æŠ½ç­¾æŒ‰é’® */
            --olympic-yellow: #FCB131;   /* é»„è‰² - å‚èµ›æŒ‰é’® */
            --olympic-black: #000000;    /* é»‘è‰² - æ·»åŠ é€‰æ‰‹æŒ‰é’® */
            --olympic-green: #00A651;    /* ç»¿è‰² - åˆ é™¤æŒ‰é’® */
            --olympic-red: #EF3340;      /* çº¢è‰² - ç”Ÿæˆèµ›ç¨‹/æ¸…ç©ºæŒ‰é’® */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: var(--color-bg); 
            color: var(--color-text);
        }
        .container {
            max-width: 1600px;
            margin: auto;
            background: var(--color-surface); 
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.15); 
        }
        h2 {
            text-align: center;
            color: var(--color-deep-blue); 
            border-bottom: 3px solid var(--color-light-blue); /* æµ…è“åº•çº¿ */
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        h3 {
            color: var(--color-deep-blue); 
            margin-top: 0;
            border-left: 5px solid var(--color-light-blue); /* æµ…è“ä¾§è¾¹ */
            padding-left: 10px;
            margin-bottom: 15px;
            padding-top: 5px;
            font-size: 1.2em;
        }
        
        /* å¸ƒå±€ */
        .main-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .results-row {
            grid-column: 1 / 4;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* é€šç”¨åŒºå—æ ·å¼ */
        .box {
            padding: 15px;
            border: 1px solid #E2E8F0; /* æµ…è¾¹æ¡† */
            border-radius: 8px;
            background: #F8F8FA; /* æ¨¡å—å†…æµ…ç° */
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        /* æ–°å¢ï¼šåˆ—è¡¨å¤´éƒ¨æ§åˆ¶åŒº */
        .list-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px; /* æ ‡é¢˜å’Œåˆ—è¡¨çš„é—´è· */
        }
        
        /* é€‰æ‰‹ç®¡ç†åŒº */
        .roster-section {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        .roster-section::-webkit-scrollbar { width: 8px; }
        .roster-section::-webkit-scrollbar-thumb { background: var(--color-light-blue); border-radius: 4px; }


        /* æ³¨å†Œæ–°é€‰æ‰‹åŒº */
        #new-participant-input {
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
            align-items: center;
        }
        #new-participant-name { 
            flex-grow: 1; 
            padding: 8px;
            background: #FFFFFF;
            color: var(--color-text);
            border: 1px solid var(--color-light-blue); /* æµ…è“è¾“å…¥æ¡†è¾¹æ¡† */
            border-radius: 4px;
        }
        
        /* æ€§åˆ«é€‰æ‹©æŒ‰é’®ç»„ */
        .gender-select-group {
            display: flex;
            border: 1px solid var(--color-light-blue); /* æµ…è“è¾¹æ¡† */
            border-radius: 4px;
            overflow: hidden;
            width: 140px; 
        }
        .gender-select-group button {
            flex: 1;
            padding: 8px 5px;
            background-color: #EBF2F7; /* æµ…è“èƒŒæ™¯ */
            color: var(--color-text);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .gender-select-group button.selected {
            background-color: var(--color-deep-blue); /* æ·±è“é€‰ä¸­ */
            color: #FFFFFF;
            font-weight: bold;
        }
        .gender-select-group button:hover:not(.selected) {
            background-color: #D3E0E9;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 10px 15px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s, box-shadow 0.3s;
            color: white; /* ç»Ÿä¸€ç™½è‰²æ–‡å­— */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* ç»Ÿä¸€æŒ‰é’®é˜´å½± */
        }
        .btn:hover {
            transform: translateY(-1px); /* æ‚¬åœå¾®åŠ¨æ•ˆæœ */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }

        /* å¥¥è¿äº”ç¯é¢œè‰²åº”ç”¨åˆ°æŒ‰é’® */
        .btn-add-primary { 
            background-color: var(--olympic-black); /* é»‘è‰² */
        }
        .btn-add-primary:hover { 
            background-color: #333333; 
        }
        
        .btn-draw { 
            background-color: var(--olympic-blue); /* è“è‰² */
        } 
        .btn-draw:hover { background-color: #006AB0; }
        
        /* ç”Ÿæˆèµ›ç¨‹/æ¸…ç©ºæŒ‰é’®å…±äº«çº¢è‰² */
        .btn-fixture, .btn-clear { 
            background-color: var(--olympic-red); /* çº¢è‰² */
            width: auto; /* æ¸…ç©ºæŒ‰é’®å®½åº¦è‡ªé€‚åº” */
            padding: 6px 10px; /* æ¸…ç©ºæŒ‰é’®å°å°ºå¯¸ */
            font-size: 0.9em;
            margin-top: 0;
        } 
        .btn-fixture:hover, .btn-clear:hover { background-color: #D62F3C; }
        
        /* åˆ—è¡¨æ“ä½œæŒ‰é’®è°ƒæ•´ - ç¼©å°å’Œå¹¶æ’ */
        .participant-item .actions button {
            padding: 4px 8px; 
            margin-left: 5px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .btn-danger { background-color: var(--olympic-green); color: white; } /* ç»¿è‰² */
        .btn-danger:hover { background-color: #008C45; }
        
        .btn-join { background-color: var(--olympic-yellow); color: white; } /* é»„è‰² */
        .btn-join:hover { background-color: #E29B27; }


        /* é€‰æ‰‹åˆ—è¡¨é¡¹æ ·å¼ (åˆ†åŒº 2 & 3) */
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0; 
            border-bottom: 1px dashed #E2E8F0;
            font-size: 0.95em;
        }
        /* æ°¸ä¹…ç¼–å·æ ·å¼ */
        .participant-item .info strong {
            color: var(--color-deep-blue); /* ç¼–å·é¢œè‰²ï¼šæ·±è“ */
            margin-right: 8px;
            font-size: 1.1em;
        }
        .participant-item .actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0; 
        }
        
        /* ç»“æœæ ·å¼ */
        .result-section {
            flex-grow: 1;
            padding: 15px;
            border: 1px solid var(--color-light-blue); /* æµ…è“è¾¹æ¡† */
            border-radius: 8px;
            overflow-y: auto;
            background: #FDFDFD; /* ææµ…èƒŒæ™¯ */
            min-height: 200px; 
        }
        .team-list { list-style: none; padding: 0; }
        .team-item { 
            background: #F0F8FF; /* ææµ…çš„è“ï¼Œæ›´æ¸©å’Œ */
            margin-bottom: 8px; 
            padding: 12px; 
            border-radius: 6px; 
            font-size: 1em;
            border-left: 4px solid var(--color-light-blue); /* æµ…è“å¼ºè°ƒ */
            color: var(--color-text);
        }
        .fixture-item {
            background: #FDFDFD; /* ææµ…èƒŒæ™¯ */
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            color: var(--color-text); 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.95em;
            border: 1px solid var(--color-light-blue); /* æµ…è“è¾¹æ¡† */
        }
        .fixture-item span:first-child { color: var(--color-deep-blue); } /* åœºæ¬¡ç¼–å·ä½¿ç”¨æ·±è“ */


        /* æ‰‹æœºç«¯å¸ƒå±€ä¼˜åŒ– (å°äº 1000px åˆ‡æ¢ä¸ºå•åˆ—) */
        @media screen and (max-width: 1000px) {
            .main-content { grid-template-columns: 1fr; }
            .results-row { grid-column: 1 / 2; grid-template-columns: 1fr; }
            .box { max-height: 50vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>â„ï¸2025é»„è±†è±†å†¬å¥¥ä¼šç¾½æ¯›çƒåˆ†ä¼šåœºğŸ†</h2>
    
    <div class="main-content">
        
        <div class="box">
            <h3>ğŸ“ æ³¨å†Œæ–°é€‰æ‰‹</h3>
            
            <div id="new-participant-input">
                <input type="text" id="new-participant-name" placeholder="è¾“å…¥é€‰æ‰‹å§“å">
                <div class="gender-select-group" id="gender-select-group">
                    <button id="male-btn" data-gender="male" class="selected" onclick="selectGender('male')">ç”·</button>
                    <button id="female-btn" data-gender="female" onclick="selectGender('female')">å¥³</button>
                </div>
            </div>
            
            <div class="input-actions">
                <button class="btn btn-add-primary" onclick="addNewParticipantAndSave()">å°†é€‰æ‰‹æ·»åŠ åˆ°å¸¸é©»é€‰æ‰‹åº“</button>
            </div>
            
        </div>
        
        <div class="box">
            <div class="list-header-controls">
                <h3>ğŸ™‹ğŸ»â€â™€ï¸å¸¸é©»é€‰æ‰‹åº“</h3>
                <button class="btn btn-clear" onclick="clearSavedParticipants()">ğŸ—‘ï¸ ä¸€é”®æ¸…ç©º</button>
            </div>
            <div id="saved-participants-list" class="roster-section">
                <p style="color: #6C757D; font-size: 0.9em; text-align: center;">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <div class="box">
            <div class="list-header-controls">
                <h3>ğŸƒ æœ¬æ¬¡å‚èµ›å¥å„¿</h3>
                <button class="btn btn-clear" onclick="clearCurrentRoster()">ğŸ—‘ï¸ ä¸€é”®æ¸…ç©º</button>
            </div>
            <div id="current-participants-list" class="roster-section">
                <p style="color: #6C757D; font-size: 0.9em; text-align: center;">ä»å¸¸é©»é€‰æ‰‹åº“é€‰æ‹©æ·»åŠ ã€‚</p>
            </div>
        </div>
        
        <div class="results-row">
            
            <div class="output-wrapper">
                <div class="controls-row">
                    <button class="btn btn-draw" id="draw-btn" onclick="drawTeams()">ğŸ§‘â€ğŸ¤â€ğŸ§‘éšæœºä¸ºå¥å„¿ç»„é˜Ÿ</button>
                </div>
                <div class="result-section">
                    <h3>ğŸ… é˜Ÿä¼åˆ†é…ç»“æœ</h3>
                    <p id="draw-status" style="color: var(--color-deep-blue);"></p>
                    <div id="team-results">
                        <p style="color: #6C757D;">è¯·ä»å·¦ä¾§é€‰æ‹©å‚èµ›å¥å„¿åï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œåˆ†ç»„ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="output-wrapper">
                <div class="controls-row">
                    <button class="btn btn-fixture" id="fixture-btn" onclick="generateFixtures()">âš”ï¸ éšæœºç”Ÿæˆæ¯”èµ›é¡ºåº</button>
                </div>
                <div class="result-section">
                    <h3>ğŸ—“ï¸ æ¯”èµ›é¡ºåº (éšæœºå¯¹é˜µ)</h3>
                    <p id="fixture-status" style="color: var(--color-deep-blue);"></p>
                    <div id="fixture-results">
                        <p style="color: #6C757D;">é˜Ÿä¼éšæœºåˆ†ç»„å®Œæˆåï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¯”èµ›é¡ºåºã€‚</p>
                    </div>
                </div>
            </div>

        </div>
        
    </div>
</div>

<script>
    // --- é…ç½®æ•°æ® (ä¸å˜) ---
    const TEAM_NAMES = [
        "å®‡å®™æ— æ•Œéœ¹é›³å°ç»„", "ç§ƒå¤´ä¹Ÿå‘å…‰é˜Ÿ", "èœé¸Ÿäº’å•„ç²¾è‹±é˜Ÿ", "å…¨åœºæœ€ä½³æ°”æ°›ç»„",
        "æ‹–åè…¿ä¹Ÿèƒ½èµ¢é˜Ÿ", "ç¥çº§èººèµ¢å¤©å›¢", "ä¸€æ‹å…¥é­‚æš´èºç»„", "è¢«ç¾½æ¯›çƒæ”¯é…é˜Ÿ",
        "ä½›ç³»å…»ç”Ÿçƒå‹é˜Ÿ", "æ‰£æ€å…¨é å¼é˜Ÿ", "ä¸€ç±³äº”æ‰£æ€é˜Ÿ", "å‘çƒå‡ºç•Œè‰ºæœ¯å›¢", 
        "é»‘æ´å¸çƒå¤§å¸ˆ", "äº”èŠ±å…«é—¨éšä¾¿æ‰“é˜Ÿ", "èººå¹³ä½†èƒ½èµ¢é˜Ÿ", "äººé—´æ¸…é†’åˆ’æ°´é˜Ÿ", 
        "ç¾½æ—èŒä¸»é©¾åˆ°", "åäººç±»ååº”é€Ÿåº¦é˜Ÿ", "çƒåœºè€å…­è”ç›Ÿ", "éç‰©è´¨æ–‡åŒ–é—äº§é˜Ÿ", 
        "å¹²é¥­äººå¹²çƒé˜Ÿ", "å¤•é˜³çº¢æ…¢æ‘‡é˜Ÿ", "å‘é™…çº¿å±æœºç»„", "çˆ±ä¸å’Œå¹³åˆ’æ°´é˜Ÿ",
        "éšæœºåº”å˜æ‚ç‰Œå†›", "ä¸€é¸£æƒŠäººé»‘é©¬é˜Ÿ", "æ·±è—ä¸éœ²åˆ’æ°´å…š", "æ™ºå•†é«˜åœ°çƒæŠ€ç›†åœ°é˜Ÿ", 
        "åªè´Ÿè´£å¸…ä¸è´Ÿè´£èµ¢é˜Ÿ", "é é¢œå€¼å–èƒœé˜Ÿ", "æˆ˜æœ¯å…¨é è’™é˜Ÿ", "å–æ°´ä¼‘æ¯ä¸“ä¸šæˆ·",
        "å¬è§é£å£°å°±èº²é˜Ÿ", "æ‹’ç»è·‘åŠ¨è”ç›Ÿ", "å…¨å‘˜é»‘çœ¼åœˆé˜Ÿ", "é€€å½¹ç”µç«é€‰æ‰‹é˜Ÿ",
        "å¯¹å®¶å¤±è¯¯æ˜¯å”¯ä¸€èµ¢é¢é˜Ÿ", "æ‹å­éƒ½æ˜¯å€Ÿçš„é˜Ÿ", "ä¸»æ‰“ä¸€ä¸ªé™ªä¼´é˜Ÿ", "è°çˆ±èµ¢è°èµ¢é˜Ÿ"
    ];

    const FORMAT_NAMES = {
        'MD': 'ç”·åŒ',
        'WD': 'å¥³åŒ',
        'XD': 'æ··åŒ'
    };

    let allTeams = {};
    // currentRosteråªå­˜å‚¨å¸¸é©»é€‰æ‰‹çš„ 'name' å±æ€§
    let currentRoster = []; 
    let selectedGender = 'male'; 

    // --- è¾…åŠ©å‡½æ•° ---

    function getNextParticipantNumber(participants) {
        // V21.6 ä¿®æ­£ï¼šè·å–å½“å‰æœ€å¤§ç¼–å·ï¼Œç”¨äºç»™æ–°é€‰æ‰‹ç¼–å·
        if (participants.length === 0) return 1;
        // æŸ¥æ‰¾æœ€å¤§çš„ç°æœ‰ç¼–å·ï¼Œä¿è¯æ–°ç¼–å·å”¯ä¸€ä¸”é€’å¢
        const maxNum = participants.reduce((max, p) => Math.max(max, p.number || 0), 0);
        return maxNum + 1;
    }

    function getParticipantDetails(name) {
        // åœ¨è·å–è¯¦æƒ…æ—¶ï¼Œè°ƒç”¨getSavedParticipantsï¼Œè¯¥å‡½æ•°ä¼šç¡®ä¿æ‰€æœ‰æ•°æ®æœ‰æœ‰æ•ˆçš„ä¸”è¿ç»­çš„ç¼–å·
        return getSavedParticipants().find(p => p.name === name);
    }
    
    function selectGender(gender) {
        selectedGender = gender;
        document.getElementById('male-btn').classList.remove('selected');
        document.getElementById('female-btn').classList.remove('selected');
        document.getElementById(`${gender}-btn`).classList.add('selected');
    }

    /**
     * è·å–ä¿å­˜çš„é€‰æ‰‹æ•°æ®ï¼Œå¹¶ä¿®æ­£ï¼ˆä¿è¯ç¼–å·ä»1å¼€å§‹è¿ç»­ï¼Œä¸”ä¸æ”¹å˜é¡ºåºï¼‰
     * ï¼ï¼ï¼æ ¸å¿ƒä¿®æ”¹é€»è¾‘ï¼ï¼ï¼
     */
    function getSavedParticipants() {
        try {
            const saved = localStorage.getItem('savedParticipants');
            let participants = saved ? JSON.parse(saved) : [];
            
            let needsSaving = false;
            
            // V21.6 ä¿®æ­£ï¼šç§»é™¤ V21.5 ä¸­çš„æŒ‰åå­—æ’åº
            // åˆ—è¡¨é¡ºåºä¿æŒä¸å˜ï¼ˆå³åŠ å…¥æ—¶çš„é¡ºåºï¼‰

            // é‡æ–°åˆ†é…ç¼–å·ï¼Œä¿è¯è¿ç»­æ€§
            for (let i = 0; i < participants.length; i++) {
                const requiredNumber = i + 1;
                // åªè¦ç¼–å·ä¸æ˜¯ i+1ï¼Œå°±éœ€è¦é‡æ–°åˆ†é…
                if (participants[i].number !== requiredNumber) {
                    participants[i].number = requiredNumber;
                    needsSaving = true;
                }
            }
            
            // å¦‚æœæœ‰ä¿®æ­£ï¼Œç«‹å³ä¿å­˜ä¿®æ­£åçš„æ•°æ®
            if (needsSaving) {
                 localStorage.setItem('savedParticipants', JSON.stringify(participants));
                 console.log("å¸¸é©»é€‰æ‰‹ç¼–å·å·²é‡æ–°åˆ†é…å¹¶ä¿å­˜ä¸ºè¿ç»­åºåˆ—ã€‚");
            }
            
            return participants;
        } catch (e) {
            console.error("æ— æ³•è¯»å–/ä¿®æ­£æœ¬åœ°å­˜å‚¨ï¼š", e);
            return [];
        }
    }

    function saveParticipantsToStorage(participants) {
        try {
            localStorage.setItem('savedParticipants', JSON.stringify(participants));
        } catch (e) {
            console.error("æ— æ³•å†™å…¥æœ¬åœ°å­˜å‚¨ï¼š", e);
        }
    }
    
    // --- UI æ¸²æŸ“å‡½æ•° ---

    /**
     * æ¸²æŸ“å¸¸é©»é€‰æ‰‹åº“åˆ—è¡¨ (åˆ†åŒº 2) - æ°¸ä¹…ç¼–å·æ˜¾ç¤º
     */
    function loadSavedParticipantsUI() {
        // è°ƒç”¨ getSavedParticipants ä¼šè‡ªåŠ¨ä¿®æ­£å¹¶é‡æ–°åˆ†é…è¿ç»­ç¼–å·
        const savedParticipants = getSavedParticipants();
        const listEl = document.getElementById('saved-participants-list');
        listEl.innerHTML = '';

        if (savedParticipants.length === 0) {
            listEl.innerHTML = '<p style="color: #6C757D; font-size: 0.9em; text-align: center;">å¸¸é©»é€‰æ‰‹åº“ä¸ºç©ºã€‚</p>';
            return;
        }

        // æ­¤æ—¶ savedParticipants å·²ç»æ˜¯æŒ‰ 1, 2, 3... è¿ç»­ç¼–å·çš„ï¼Œä¸”é¡ºåºä¿æŒä¸ºåŠ å…¥æ—¶çš„é¡ºåº
        savedParticipants.forEach((p) => {
            const item = document.createElement('div');
            item.className = 'participant-item';
            const genderText = p.gender === 'male' ? 'ç”·' : 'å¥³';
            const numberText = `${p.number}å·é€‰æ‰‹`; 
            
            item.innerHTML = `
                <div class="info"><strong>${numberText}</strong>ï¼š${p.name} (${genderText})</div>
                <div class="actions">
                    <button class="btn btn-join" onclick="addToRoster('${p.name}')">å‚èµ›</button>
                    <button class="btn btn-danger" onclick="deleteSavedParticipant('${p.name}')">åˆ é™¤</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }

    /**
     * æ¸²æŸ“æœ¬æ¬¡å‚èµ›å¥å„¿åˆ—è¡¨ (åˆ†åŒº 3) - æ˜¾ç¤ºæ°¸ä¹…ç»‘å®šåºå·
     */
    function loadCurrentRosterUI() {
        const listEl = document.getElementById('current-participants-list');
        listEl.innerHTML = '';

        if (currentRoster.length === 0) {
            listEl.innerHTML = '<p style="color: #6C757D; font-size: 0.9em; text-align: center;">å½“å‰æ²¡æœ‰å‚èµ›å¥å„¿ï¼Œè¯·ä»å¸¸é©»é€‰æ‰‹åº“é€‰æ‹©æ·»åŠ ã€‚</p>';
            return;
        }

        currentRoster.forEach((name) => {
            // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»å†æ¬¡è°ƒç”¨ getParticipantDetails æ¥è·å–æœ€æ–°çš„ï¼ˆå¯èƒ½å·²è¢«é‡æ–°åˆ†é…çš„ï¼‰ç¼–å·
            const p = getParticipantDetails(name); 
            if (!p) return; 

            const item = document.createElement('div');
            item.className = 'participant-item';
            const genderText = p.gender === 'male' ? 'ç”·' : 'å¥³';
            // ä½¿ç”¨æ°¸ä¹…ç»‘å®šçš„ number å±æ€§
            const numberText = `${p.number}å·é€‰æ‰‹`; 
            
            item.innerHTML = `
                <div class="info"><strong>${numberText}</strong>ï¼š${p.name} (${genderText})</div>
                <div class="actions">
                    <button class="btn btn-danger" onclick="removeFromRoster('${p.name}')">ç§»é™¤</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }
    
    // --- å¸¸é©»é€‰æ‰‹åº“é€»è¾‘ ---

    /**
     * æ·»åŠ æ–°é€‰æ‰‹ - åˆ†é…æ–°ç¼–å·ï¼ˆæ ¹æ®å½“å‰æœ€å¤§å€¼ + 1ï¼‰
     */
    function addNewParticipantAndSave() {
        const nameInput = document.getElementById('new-participant-name');
        const name = nameInput.value.trim();
        const gender = selectedGender; 

        if (!name) {
            alert('è¯·è¾“å…¥é€‰æ‰‹å§“åã€‚');
            return;
        }
        
        let savedParticipants = getSavedParticipants(); // è·å–å½“å‰è¿ç»­ç¼–å·çš„åˆ—è¡¨
        const existingPlayer = savedParticipants.find(p => p.name === name);

        if (existingPlayer) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œä»…æ›´æ–°æ€§åˆ«
            existingPlayer.gender = gender;
            alert(`é€‰æ‰‹ "${name}" å·²å­˜åœ¨ï¼Œå·²æ›´æ–°æ€§åˆ«ä¸º ${gender === 'male' ? 'ç”·' : 'å¥³'} (ID ${existingPlayer.number})ã€‚`);
            saveParticipantsToStorage(savedParticipants); 
        } else {
            // æ–°å¢é€‰æ‰‹ï¼šåŠ å…¥åˆ—è¡¨æœ«å°¾ï¼Œå¹¶è·å–å½“å‰æœ€å¤§å· + 1 ä½œä¸ºç¼–å·
            const newNumber = getNextParticipantNumber(savedParticipants);
            savedParticipants.push({ name, gender, number: newNumber });
            alert(`é€‰æ‰‹ "${name}" å·²æˆåŠŸæ·»åŠ åˆ°å¸¸é©»é€‰æ‰‹åº“ (ID ${newNumber})ã€‚`);
            saveParticipantsToStorage(savedParticipants); 
        }

        loadSavedParticipantsUI(); // é‡æ–°åŠ è½½åˆ—è¡¨ï¼Œå¯èƒ½ä¼šè§¦å‘ç¼–å·ä¿®æ­£ï¼ˆä½†é€šå¸¸ä¸ä¼šï¼Œå› ä¸ºæ–°å·æ˜¯ max+1ï¼‰
        nameInput.value = '';
        selectGender('male'); 
    }

    /**
     * åˆ é™¤å¸¸é©»é€‰æ‰‹ï¼Œå¹¶é‡æ–°æ’åºç¼–å·ï¼ˆæ ¸å¿ƒä¿®æ”¹ç‚¹ï¼‰
     */
    function deleteSavedParticipant(nameToDelete) {
        if (currentRoster.includes(nameToDelete)) {
            alert(`è¯·å…ˆå°†é€‰æ‰‹ "${nameToDelete}" ä»ã€æœ¬æ¬¡å‚èµ›å¥å„¿ã€‘ä¸­ç§»é™¤ï¼Œå†è¿›è¡Œåˆ é™¤æ“ä½œã€‚`);
            return;
        }
        
        const player = getParticipantDetails(nameToDelete);
        if (!confirm(`ç¡®å®šè¦ä»å¸¸é©»é€‰æ‰‹åº“ä¸­åˆ é™¤ "${nameToDelete}" (ID ${player.number}) å—ï¼Ÿ\nåˆ é™¤åï¼Œå…¶ä½™é€‰æ‰‹çš„ç¼–å·å°†é‡æ–°æ’åºï¼Œä½†åå•é¡ºåºä¸å˜ã€‚`)) return;
        
        let savedParticipants = getSavedParticipants();
        // 1. è¿‡æ»¤æ‰è¦åˆ é™¤çš„é€‰æ‰‹
        savedParticipants = savedParticipants.filter(p => p.name !== nameToDelete);
        
        // 2. é‡æ–°åˆ†é…ç¼–å·ï¼š
        //   - å°†è¿‡æ»¤åçš„åˆ—è¡¨ä¿å­˜å› localStorageã€‚
        //   - è°ƒç”¨ getSavedParticipants() ä¼šè‡ªåŠ¨åŠ è½½æ–°åˆ—è¡¨ï¼Œå¹¶æ ¹æ®åˆ—è¡¨ç°æœ‰é¡ºåºï¼ˆå³åŠ å…¥é¡ºåºï¼‰é‡æ–°åˆ†é… 1, 2, 3... çš„è¿ç»­ç¼–å·ï¼Œå¹¶å†æ¬¡ä¿å­˜ã€‚
        saveParticipantsToStorage(savedParticipants); 
        getSavedParticipants(); // è§¦å‘ç¼–å·é‡æ’å’Œä¿å­˜
        
        loadSavedParticipantsUI(); 
        loadCurrentRosterUI(); // é‡æ–°åŠ è½½å‚èµ›å¥å„¿åå•ï¼Œç¡®ä¿ç¼–å·æ›´æ–°
    }

    /**
     * è¡Œä¸ºï¼šæ¸…ç©ºå¸¸é©»é€‰æ‰‹åº“ (åŒ…æ‹¬LocalStorage)
     */
    function clearSavedParticipants() {
        if (getSavedParticipants().length === 0) return;
        if (!confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºã€å¸¸é©»é€‰æ‰‹åº“ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;

        localStorage.removeItem('savedParticipants');
        // åŒæ—¶æ¸…ç©ºå½“å‰å‚èµ›åå•ï¼Œå› ä¸ºå®ƒä»¬çš„å¼•ç”¨ä¼šå¤±æ•ˆ
        currentRoster = [];
        allTeams = {};
        
        loadSavedParticipantsUI();
        loadCurrentRosterUI();
        document.getElementById('team-results').innerHTML = '<p style="color: #6C757D;">è¯·ä»å·¦ä¾§é€‰æ‹©å‚èµ›å¥å„¿åï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œåˆ†ç»„ã€‚</p>';
        document.getElementById('fixture-results').innerHTML = '<p style="color: #6C757D;">é˜Ÿä¼éšæœºåˆ†ç»„å®Œæˆåï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¯”èµ›é¡ºåºã€‚</p>';
        document.getElementById('draw-status').textContent = '';
        document.getElementById('fixture-status').textContent = '';

        alert("å¸¸é©»é€‰æ‰‹åº“å·²æ¸…ç©ºï¼Œæœ¬æ¬¡å‚èµ›å¥å„¿åå•ä¹Ÿå·²é‡ç½®ã€‚");
    }


    // --- å‚èµ›å¥å„¿åå•é€»è¾‘ ---

    function addToRoster(name) {
        const exists = currentRoster.includes(name);
        if (exists) {
            alert(`é€‰æ‰‹ "${name}" å·²åœ¨æœ¬æ¬¡å‚èµ›å¥å„¿åå•ä¸­ã€‚`);
            return;
        }
        currentRoster.push(name);
        loadCurrentRosterUI(); 
    }

    function removeFromRoster(name) {
        currentRoster = currentRoster.filter(n => n !== name);
        loadCurrentRosterUI();
    }

    /**
     * è¡Œä¸ºï¼šæ¸…ç©ºæœ¬æ¬¡å‚èµ›å¥å„¿åå•
     */
    function clearCurrentRoster() {
        if (currentRoster.length === 0) return;
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºã€æœ¬æ¬¡å‚èµ›å¥å„¿ã€‘åå•å—ï¼Ÿ")) return;

        currentRoster = [];
        allTeams = {}; // æ¸…ç©ºé˜Ÿä¼åˆ†é…ç»“æœ
        
        loadCurrentRosterUI();
        document.getElementById('team-results').innerHTML = '<p style="color: #6C757D;">è¯·ä»å·¦ä¾§é€‰æ‹©å‚èµ›å¥å„¿åï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œåˆ†ç»„ã€‚</p>';
        document.getElementById('fixture-results').innerHTML = '<p style="color: #6C757D;">é˜Ÿä¼éšæœºåˆ†ç»„å®Œæˆåï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¯”èµ›é¡ºåºã€‚</p>';
        document.getElementById('draw-status').textContent = '';
        document.getElementById('fixture-status').textContent = '';
        
        alert("æœ¬æ¬¡å‚èµ›å¥å„¿åå•å·²æ¸…ç©ºã€‚");
    }

    // --- æ ¸å¿ƒåˆ†ç»„å’Œæ¯”èµ›é€»è¾‘ (ä¸å˜) ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function getRandomTeamName() {
        const index = Math.floor(Math.random() * TEAM_NAMES.length);
        return TEAM_NAMES[index];
    }
    
    function drawTeams() {
        // å°† currentRoster ä¸­çš„ name è½¬æ¢ä¸ºå®Œæ•´çš„ participant å¯¹è±¡
        // æ¯æ¬¡è°ƒç”¨ getParticipantDetails éƒ½ä¼šæ‹¿åˆ°æœ€æ–°çš„ç¼–å·
        const participants = currentRoster.map(name => getParticipantDetails(name)).filter(p => p);

        const statusEl = document.getElementById('draw-status');
        const resultsEl = document.getElementById('team-results');
        
        statusEl.textContent = '';
        resultsEl.innerHTML = '';
        allTeams = { 'MD': [], 'WD': [], 'XD': [] };

        if (participants.length < 2) {
            resultsEl.innerHTML = '<p style="color: #6C757D;">è¯·ä»å¸¸é©»é€‰æ‰‹åº“é€‰æ‹©è‡³å°‘2ä½å‚èµ›å¥å„¿ã€‚</p>';
            statusEl.textContent = 'â— è‡³å°‘éœ€è¦2ä½å‚èµ›å¥å„¿æ‰èƒ½å°è¯•ç»„é˜Ÿã€‚';
            return;
        }

        const malePool = participants.filter(p => p.gender === 'male');
        const femalePool = participants.filter(p => p.gender === 'female');
        
        const maleMD_Pool = [...malePool];
        const femaleWD_Pool = [...femalePool];
        const maleXD_Pool = [...malePool];
        const femaleXD_Pool = [...femalePool];

        function createDoubles(pool, format) {
            shuffleArray(pool); 
            const teams = [];
            while (pool.length >= 2) {
                const player1 = pool.pop();
                const player2 = pool.pop();
                // é˜Ÿä¼åˆ†é…ç»“æœåªæ˜¾ç¤ºåå­—
                teams.push({
                    name: getRandomTeamName() + ` (${FORMAT_NAMES[format]})`, 
                    members: [`${player1.name}`, `${player2.name}`]
                });
            }
            return teams;
        }

        function createMixedDoubles(malePool, femalePool) {
            shuffleArray(malePool);
            shuffleArray(femalePool);
            const teams = [];
            const numTeams = Math.min(malePool.length, femalePool.length);

            for (let i = 0; i < numTeams; i++) {
                const malePlayer = malePool.pop();
                const femalePlayer = femalePool.pop();
                // é˜Ÿä¼åˆ†é…ç»“æœåªæ˜¾ç¤ºåå­—
                teams.push({
                    name: getRandomTeamName() + ` (${FORMAT_NAMES['XD']})`,
                    members: [`${malePlayer.name}`, `${femalePlayer.name}`]
                });
            }
            return teams;
        }

        if (maleMD_Pool.length >= 2) {
            allTeams['MD'] = createDoubles(maleMD_Pool, 'MD');
            if (maleMD_Pool.length === 1) { statusEl.textContent += 'âš ï¸ ç”·åŒäººæ•°ä¸ºå•æ•°ï¼Œæœ‰1äººè½®ç©ºã€‚\n'; } 
            else if (allTeams['MD'].length < 2) { statusEl.textContent += 'âš ï¸ ç”·åŒé˜Ÿä¼æ•°é‡ä¸è¶³2é˜Ÿã€‚\n'; }
        }

        if (femaleWD_Pool.length >= 2) {
            allTeams['WD'] = createDoubles(femaleWD_Pool, 'WD');
            if (femaleWD_Pool.length === 1) { statusEl.textContent += 'âš ï¸ å¥³åŒäººæ•°ä¸ºå•æ•°ï¼Œæœ‰1äººè½®ç©ºã€‚\n'; } 
            else if (allTeams['WD'].length < 2) { statusEl.textContent += 'âš ï¸ å¥³åŒé˜Ÿä¼æ•°é‡ä¸è¶³2é˜Ÿã€‚\n'; }
        }
        
        if (maleXD_Pool.length >= 1 && femaleXD_Pool.length >= 1) {
            allTeams['XD'] = createMixedDoubles(maleXD_Pool, femaleXD_Pool);
            
            let remainingMale = maleXD_Pool.length;
            let remainingFemale = femaleXD_Pool.length;
            if (remainingMale > 0 || remainingFemale > 0) {
                 statusEl.textContent += `âš ï¸ æ··åŒæœ‰${remainingMale > 0 ? remainingMale + 'ç”·é€‰æ‰‹' : ''}${remainingFemale > 0 ? remainingFemale + 'å¥³é€‰æ‰‹' : ''}å› äººæ•°ä¸å¹³è¡¡è½®ç©ºã€‚\n`;
            }
            if (allTeams['XD'].length < 2 && malePool.length >= 2 && femalePool.length >= 2) {
                statusEl.textContent += 'âš ï¸ æ··åŒé˜Ÿä¼æ•°é‡ä¸è¶³2é˜Ÿã€‚\n';
            }
        }

        let html = '';
        for (const format in allTeams) {
            if (allTeams[format].length > 0) {
                const formatName = FORMAT_NAMES[format] || format;
                html += `<h4>${formatName} èµ›åˆ¶ (${allTeams[format].length} æ”¯é˜Ÿä¼)</h4>`;
                html += '<ul class="team-list">';
                allTeams[format].forEach(team => {
                    html += `<li class="team-item"><strong>${team.name}</strong>ï¼š${team.members.join(' & ')}</li>`;
                });
                html += '</ul>';
            }
        }
        
        if (!html) {
             statusEl.textContent = 'â— äººæ•°ä¸è¶³æˆ–æ€§åˆ«ä¸å¹³è¡¡ï¼Œæ— æ³•ç»„æˆä»»ä½•é˜Ÿä¼ã€‚';
        } else {
            resultsEl.innerHTML = html;
        }
        
        document.getElementById('fixture-results').innerHTML = '<p style="color: #6C757D;">é˜Ÿä¼éšæœºåˆ†ç»„å®Œæˆåï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¯”èµ›é¡ºåºã€‚</p>';
        document.getElementById('fixture-status').textContent = '';
    }

    function generateFixtures() {
        const statusEl = document.getElementById('fixture-status');
        const resultsEl = document.getElementById('fixture-results');
        resultsEl.innerHTML = '';
        statusEl.textContent = '';
        
        if (Object.keys(allTeams).length === 0 || Object.values(allTeams).every(arr => arr.length === 0)) {
            resultsEl.innerHTML = '<p style="color: #6C757D;">é˜Ÿä¼éšæœºåˆ†ç»„å®Œæˆåï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ¯”èµ›é¡ºåºã€‚</p>';
            statusEl.textContent = 'â— è¯·å…ˆç‚¹å‡»â€œéšæœºä¸ºå¥å„¿ç»„é˜Ÿâ€ç”Ÿæˆé˜Ÿä¼ã€‚';
            return;
        }

        let totalFixtureCount = 0;
        let html = '';
        
        for (const format in allTeams) {
            const teams = allTeams[format];
            if (teams.length >= 2) {
                const fixtures = [];
                const shuffledTeams = [...teams];
                shuffleArray(shuffledTeams);

                for (let i = 0; i < shuffledTeams.length; i++) {
                    for (let j = i + 1; j < shuffledTeams.length; j++) {
                        fixtures.push([shuffledTeams[i].name, shuffledTeams[j].name]);
                    }
                }
                
                shuffleArray(fixtures);
                
                const formatName = FORMAT_NAMES[format] || format;
                html += `<h4>âš”ï¸ ${formatName} èµ›åˆ¶ æ¯”èµ›é¡ºåº (${fixtures.length} åœº)</h4>`;
                let fixtureHtml = '<ol>';
                fixtures.forEach((pair, index) => {
                    totalFixtureCount++;
                    // ç§»é™¤é˜Ÿä¼åç§°ä¸­çš„èµ›åˆ¶åç¼€ï¼Œä½¿å¯¹é˜µæ›´æ¸…æ™°
                    const team1Name = pair[0].split('(')[0].trim();
                    const team2Name = pair[1].split('(')[0].trim();
                    fixtureHtml += `<li class="fixture-item"><span>ç¬¬ ${index + 1} åœº</span><span><strong>${team1Name}</strong> VS <strong>${team2Name}</strong></span></li>`;
                });
                fixtureHtml += '</ol>';
                html += fixtureHtml;
            } else if (teams.length > 0) {
                const formatName = FORMAT_NAMES[format] || format;
                html += `<h4>âš”ï¸ ${formatName} èµ›åˆ¶</h4><p style="color: var(--color-danger);">é˜Ÿä¼æ•°é‡ä¸è¶³2æ”¯ï¼Œæ— æ³•ç”Ÿæˆæ¯”èµ›å¯¹é˜µã€‚</p>`;
            }
        }
        
        if (totalFixtureCount > 0) {
            resultsEl.innerHTML = html;
        } else {
            statusEl.textContent = 'â— æ‰€æœ‰èµ›åˆ¶é˜Ÿä¼æ•°é‡å‡ä¸è¶³2æ”¯ï¼Œæ— æ³•ç”Ÿæˆå¯¹é˜µã€‚';
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        // åœ¨åŠ è½½ UI å‰å…ˆä¿®æ­£æ•°æ®ï¼ˆç°åœ¨ä¼šè‡ªåŠ¨é‡æ–°åˆ†é…è¿ç»­ç¼–å·ï¼‰
        getSavedParticipants(); 
        loadSavedParticipantsUI();
        loadCurrentRosterUI();
        selectGender('male'); 
    };
</script>
</body>
</html>
